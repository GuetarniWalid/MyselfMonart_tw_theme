{%- unless request.design_mode -%}
  <div id="cookies-banner" class="fixed bottom-6 left-5 md:left-16 right-5 bg-secondary transition-colors duration-500 border-1 border-main rounded-xl max-w-[550px] px-6 z-50 hidden">
    <img
      src="{{ "cookie.png" | file_img_url: '280x' }}"
      width="280"
      height="280"
      alt="Cookie icon"
      class="absolute -top-20 left-1/2 -translate-x-1/2 md:-top-16 md:-left-16 md:translate-x-0"
      loading="lazy" />
    <div class="first ml-auto py-7 pt-52 md:w-1/2 md:pt-7">
      <p>{{ 'sections.cookie_banner.message-1' | t }}<br>{{ 'sections.cookie_banner.message-2' | t }}</p>
      <div class="flex gap-6 md:justify-between mt-6">
        <button onclick="showSettings()" class="underline">{{ 'sections.cookie_banner.parameter' | t }}</button>
        <button onclick="handleAccept()" class="bg-main text-secondary transition-colors duration-500 py-3 px-6 rounded-lg">{{ 'sections.cookie_banner.accept' | t }}</button>
      </div>
    </div>
    <form class="second hidden py-7 pt-52 md:w-7/12 ml-auto md:pt-7" onsubmit="handleSettings(event)">
      <p class="text-xl font-heading font-bold mb-4">{{ 'sections.cookie_banner.settings.title' | t }}</p>
      <div class="flex gap-2 items-center mb-3 cursor-pointer relative">
        <div
          class="inline-block relative w-5 h-5 rounded overflow-hidden cursor-pointer"
          role="checkbox"
          aria-checked="true"
          onclick="handleCheck(this)">
          <input
            id="cookie-analyse"
            class="h-full w-full appearance-none border-2 border-main checked:border-0 peer"
            type="checkbox"
            name="analytics"
            checked />
          <div class="absolute top-0 left-0 h-full w-full -z-10 peer-checked:bg-main"></div>
          <svg
            width="12"
            height="10"
            viewBox="0 0 12 10"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
            class="absolute text-secondary transition-colors duration-500 top-1 left-1 block -z-10">
            <path d="M4.5 9.20078L0.5 5.20078L1.9 3.80078L4.5 6.40078L10.1 0.800781L11.5 2.20078L4.5 9.20078Z" fill="currentColor" />
          </svg>
        </div>
        <label for="cookie-analyse" class="cursor-pointer">
          {{ 'sections.cookie_banner.settings.analytics' | t }}
        </label>
      </div>
      <div class="flex gap-2 items-center mb-3 cursor-pointer relative">
        <div
          class="inline-block relative w-5 h-5 rounded overflow-hidden cursor-pointer"
          role="checkbox"
          aria-checked="true"
          onclick="handleCheck(this)">
          <input
            id="cookie-marketing"
            class="h-full w-full appearance-none border-2 border-main checked:border-0 peer"
            type="checkbox"
            name="marketing"
            checked />
          <div class="absolute top-0 left-0 h-full w-full -z-10 peer-checked:bg-main"></div>
          <svg
            width="12"
            height="10"
            viewBox="0 0 12 10"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
            class="absolute text-secondary transition-colors duration-500 top-1 left-1 block -z-10">
            <path d="M4.5 9.20078L0.5 5.20078L1.9 3.80078L4.5 6.40078L10.1 0.800781L11.5 2.20078L4.5 9.20078Z" fill="currentColor" />
          </svg>
        </div>
        <label for="cookie-marketing" class="cursor-pointer">
          {{ 'sections.cookie_banner.settings.marketing' | t }}
        </label>
      </div>
      <div class="block gap-2 mb-3 cursor-pointer relative">
        <div
          class="inline-block relative w-5 h-5 rounded overflow-hidden cursor-pointer mr-1"
          role="checkbox"
          aria-checked="true"
          onclick="handleCheck(this)">
          <input
            id="cookie-preferences"
            class="h-full w-full appearance-none border-2 border-main checked:border-0 peer"
            type="checkbox"
            name="preferences"
            checked />
          <div class="absolute top-0 left-0 h-full w-full -z-10 peer-checked:bg-main"></div>
          <svg
            width="12"
            height="10"
            viewBox="0 0 12 10"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
            class="absolute text-secondary transition-colors duration-500 top-1 left-1 block -z-10">
            <path d="M4.5 9.20078L0.5 5.20078L1.9 3.80078L4.5 6.40078L10.1 0.800781L11.5 2.20078L4.5 9.20078Z" fill="currentColor" />
          </svg>
        </div>
        <label for="cookie-preferences" class="cursor-pointer">
          {{ 'sections.cookie_banner.settings.preferences' | t }}
        </label>
      </div>
      <div class="block gap-2 mb-3 cursor-pointer relative">
        <div
          class="inline-block relative w-5 h-5 rounded overflow-hidden cursor-pointer mr-1"
          role="checkbox"
          aria-checked="true"
          onclick="handleCheck(this)">
          <input
            id="cookie-sale_of_data"
            class="h-full w-full appearance-none border-2 border-main checked:border-0 peer"
            type="checkbox"
            name="sale_of_data"
            checked />
          <div class="absolute top-0 left-0 h-full w-full -z-10 peer-checked:bg-main"></div>
          <svg
            width="12"
            height="10"
            viewBox="0 0 12 10"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
            class="absolute text-secondary transition-colors duration-500 top-1 left-1 block -z-10">
            <path d="M4.5 9.20078L0.5 5.20078L1.9 3.80078L4.5 6.40078L10.1 0.800781L11.5 2.20078L4.5 9.20078Z" fill="currentColor" />
          </svg>
        </div>
        <label for="cookie-sale_of_data" class="cursor-pointer">
          {{ 'sections.cookie_banner.settings.sale_of_data' | t }}
        </label>
      </div>
      <button class="block bg-main py-3 text-center text-secondary transition-colors duration-500 w-full rounded mb-2" onclick="handleAccept()">{{ 'sections.cookie_banner.settings.accept_button' | t }}</button>
      <button class="block border-main border-1 py-3 text-center w-full rounded" type="submit">{{ 'sections.cookie_banner.settings.save_button' | t }}</button>
    </form>
  </div>

  <script>
    function getBannerEl() {
      return document.getElementById('cookies-banner');
    }
    
    function hideBanner(res) {
      getBannerEl().style.display = 'none';
    }
    
    function showBanner() {
    getBannerEl().classList.replace('hidden', 'animate-bounceFromLeft');
    }
    
    function handleCheck(div) {
      const isChecked = div.getAttribute('aria-checked') === 'true';
      div.setAttribute('aria-checked', !isChecked);
    }
    
    function handleAccept(e) {
      window.Shopify.customerPrivacy.setTrackingConsent(true, hideBanner);
    
      document.addEventListener('trackingConsentAccepted',function() {
        console.log('trackingConsentAccepted event fired');
      });
    }
    
    function showSettings() {
      document.querySelector('#cookies-banner > div.first').classList.add('hidden');
      document.querySelector('#cookies-banner > .second').classList.remove('hidden');
    }
    
    function handleSettings(event) {
      event.preventDefault();
      const form = event.target;
      const inputs = Array.from(form.elements);
    
      const formValues = {};
      inputs.forEach(input => {
          if (input.type !== 'submit') {
              formValues[input.name] = input.checked;
          }
      });
    
      window.Shopify.customerPrivacy.setTrackingConsent(formValues,() => {
        hideBanner()
        console.log("Consent captured")
        });
    }
    
    function areVisitorConsentsEmpty(consents) {
      for (let key in consents) {
        if (consents.hasOwnProperty(key)) {
          if (consents[key] !== '') {
            return false;
          }
        }
      }
      return true;
    }
    
    function initCookieBanner() {
      // Don't show banner in theme editor
      if (window.Shopify.designMode) {
        return;
      }

      // Don't show banner in local development (shopify theme dev)
      const isLocalDev = window.location.hostname === 'localhost' ||
                         window.location.hostname === '127.0.0.1' ||
                         window.location.hostname.includes('.local');

      if (isLocalDev) {
        return;
      }

      setTimeout(() => {
        const currentVisitorConsent = window.Shopify.customerPrivacy.currentVisitorConsent();

        const visitorConsentsEmpty = areVisitorConsentsEmpty(currentVisitorConsent);
        const shouldShowBanner = window.Shopify.customerPrivacy.shouldShowBanner();

        if(shouldShowBanner && visitorConsentsEmpty) {
          showBanner();
          }
      }, 2000)
    }
    
    window.Shopify.loadFeatures([
      {
        name: 'consent-tracking-api',
        version: '0.1',
      }
    ],
    (error) => {
      if (error) {
        throw error;
      }
      initCookieBanner();
    });
  </script>
{%- endunless -%}