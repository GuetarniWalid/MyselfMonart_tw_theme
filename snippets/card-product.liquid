{% comment %}
    Renders a product card
    Accepts:
    - product: {Object} The product object
    - primary_image_index: {Number} Which image to show as primary (1-based index). Default: 1 (optional)
    - next_image_index: {Number} Which image to show on hover (1-based index). Default: 0 (no hover image) (optional)
    - lazy_load: {Boolean} Image should be lazy loaded. Default: true (optional)
    - section_id: {String} The ID of the section that contains this card.
    Usage:
    {% render 'card-product' %}
{% endcomment %}

<div class="h-full flex flex-col justify-end">
  {%- liquid
    assign primary_index_input = primary_image_index | default: 1
    assign primary_index = primary_index_input | minus: 1
    assign primary_image = product.media[primary_index]
    if primary_image == nil
      assign primary_image = product.featured_media
    endif

    assign next_image_index_input = next_image_index | default: 0
    assign should_show_next = false
    assign next_image = nil
    if next_image_index_input > 0
      assign next_index = next_image_index_input | minus: 1
      assign next_image = product.media[next_index]
      if next_image != nil
        assign should_show_next = true
      endif
    endif
  -%}

  {%- if primary_image -%}
    <div class="mb-2 md:mb-5">
      <div class="skeleton overflow-hidden relative w-full duration-100" style="aspect-ratio: {{ primary_image.width }} / {{ primary_image.height }}">
        <img
          data-srcset="{%- if primary_image.width >= 200 -%}{{ primary_image | image_url: width: 200 }} 200w,{%- endif -%}
            {%- if primary_image.width >= 300 -%}{{ primary_image | image_url: width: 300 }} 300w,{%- endif -%}
            {%- if primary_image.width >= 400 -%}{{ primary_image | image_url: width: 400 }} 400w,{%- endif -%}
            {%- if primary_image.width >= 500 -%}{{ primary_image | image_url: width: 500 }} 500w,{%- endif -%}
            {{ primary_image | image_url }} {{ primary_image.width }}w"
          src="{{ primary_image | image_url: width: 10 }}"
          sizes="(min-width: 768px) 33%, (min-width: 1024px) 300px, 50%"
          alt="{% if product.metafields.meta_object.media.value.alts.value[1] %}{{ product.metafields.meta_object.media.value.alts.value[1] | escape }}{% else %}{{ product.media[1].alt | escape }}{% endif %}"
          loading="lazy"
          width="{{ primary_image.width }}"
          height="{{ primary_image.height }}"
          class="lqip w-full h-full object-contain">

        {%- if should_show_next -%}
          <img
            data-srcset="{%- if next_image.width >= 200 -%}{{ next_image | image_url: width: 200 }} 200w,{%- endif -%}
              {%- if next_image.width >= 300 -%}{{ next_image | image_url: width: 300 }} 300w,{%- endif -%}
              {%- if next_image.width >= 400 -%}{{ next_image | image_url: width: 400 }} 400w,{%- endif -%}
              {%- if next_image.width >= 500 -%}{{ next_image | image_url: width: 500 }} 500w,{%- endif -%}
              {{ next_image | image_url }} {{ next_image.width }}w"
            src="{{ next_image | image_url: width: 40 }}"
            sizes="(min-width: 768px) 33%, (min-width: 1024px) 300px, 50%"
            alt="{% if product.metafields.meta_object.media.value.alts.value[0] %}{{
              product.metafields.meta_object.media.value.alts.value[0] | escape }}{% else %}{{ next_image.alt | escape }}{% endif %}"
            {% unless lazy_load == false %}
            loading="lazy"
            {% endunless %}
            width="{{ next_image.width }}"
            height="{{ next_image.height }}"
            class="lqip absolute top-0 left-0 w-full h-full object-cover opacity-0 group-hover:opacity-100 duration-200 rounded-lg {% if
              next_image.width >= next_image.height %}object-top{% endif %}">
        {%- endif -%}
    </div>
  {%- endif -%}

  <div class="p-3 flex flex-col justify-between">
    <h3 class="text-xs leading-normal">
      <a
        href="{{ product.url }}"
        class="product-card-title after:absolute after:inset-0 block overflow-hidden line-clamp-3"
        tabindex="-1"
        data-full-title="{{ product.title | escape | upcase }}">
        {{ product.title | escape | upcase }}
      </a>
    </h3>
    <div class="mt-2 sm:mt-3 flex justify-between items-center price-and-likes">
      {% render 'my-like-button', product: product, likes_count: product.metafields.likes.number | default: 0 %}
      <template class="likes-count-container-template">
        {% render 'my-like-button'
          , product: product
          , likes_count: 0 %}
      </template>
      <p class="text-sm md:mr-2">
        <strong>{{ product.price_min | money }}</strong>
      </p>
    </div>
  </div>
</div>

<script>
(function() {
  function truncateTitleFromStart(element) {
    const fullTitle = element.dataset.fullTitle;
    if (!fullTitle) return;

    // Get the computed line height
    const style = window.getComputedStyle(element);
    const lineHeight = parseFloat(style.lineHeight);
    const maxHeight = lineHeight * 3; // 3 lines max

    // Reset to full title first
    element.textContent = fullTitle;

    // If it fits, no need to truncate
    if (element.scrollHeight <= maxHeight + 2) { // +2px tolerance
      return;
    }

    // Binary search to find the optimal starting position
    let left = 0;
    let right = fullTitle.length;
    let bestStart = 0;

    while (left <= right) {
      const mid = Math.floor((left + right) / 2);
      const testText = '...' + fullTitle.substring(mid);
      element.textContent = testText;

      if (element.scrollHeight <= maxHeight + 2) {
        bestStart = mid;
        right = mid - 1; // Try to show more text
      } else {
        left = mid + 1; // Need to truncate more
      }
    }

    // Apply the best fit with smart spacing
    let finalText;
    if (fullTitle[bestStart] === ' ') {
      finalText = '... ' + fullTitle.substring(bestStart + 1);

      // Verify it still fits with the extra space
      element.textContent = finalText;
      if (element.scrollHeight > maxHeight + 2) {
        finalText = '...' + fullTitle.substring(bestStart);
      }
    } else {
      // We're in the middle of a word
      // Find the end of this broken word
      const nextSpaceIndex = fullTitle.indexOf(' ', bestStart);
      const brokenWordLength = (nextSpaceIndex === -1)
        ? fullTitle.length - bestStart
        : nextSpaceIndex - bestStart;

      if (brokenWordLength < 3) {
        const nextWordStart = nextSpaceIndex === -1 ? fullTitle.length : nextSpaceIndex + 1;
        finalText = '... ' + fullTitle.substring(nextWordStart);

        // Verify it still fits
        element.textContent = finalText;
        if (element.scrollHeight > maxHeight + 2) {
          finalText = '...' + fullTitle.substring(bestStart);
        }
      } else {
        finalText = '...' + fullTitle.substring(bestStart);
      }
    }

    element.textContent = finalText;
  }

  function initTruncation() {
    const titles = document.querySelectorAll('.product-card-title[data-full-title]');
    titles.forEach(truncateTitleFromStart);
  }

  // Run on load and after fonts are loaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTruncation);
  } else {
    initTruncation();
  }

  if (document.fonts) {
    document.fonts.ready.then(initTruncation);
  }
})();
</script>