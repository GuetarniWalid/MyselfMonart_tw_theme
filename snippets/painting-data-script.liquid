{% comment %} 
  Renders the scripts containing the paintings data 
  Accepts: 
  - product: {Object} 
{% endcomment %}


<script id="product-data">
  window.react = {
    buyButton: {
      addProductToCart: "{{ 'react.buyButton.addProductToCart' | t }}",
      addCustomerDetails: "{{ 'react.buyButton.addCustomerDetails' | t }}",
      total: "{{ 'react.buyButton.total' | t }}",
    },
    errorMessage: {
      notAvailableFor: "{{ 'react.errorMessage.notAvailableFor' | t }}",
      poster: "{{ 'react.errorMessage.poster' | t }}",
    }
  };
  {% if product.metafields.product.customer_details != blank %}
    window.buyingWithCustomization = true;
    window.customerDetailsSchema = {{ product.metafields.product.customer_details }};
  {% endif %}
  
  window.productImageSRC = "{{ product.images[1] | image_url | prepend: 'https:' }}";
  window.productImageAlt = "{{ product.metafields.meta_object.media.value.alts.value[1] | escape }}";
  window.canvasTexture = "{{ 'snippet.paintings_data_script.canvas_texture' | t }}";
  window.productId = "{{ product.id }}";
  window.shopUrl = window.Shopify.routes.root;
  {%- for block in section.blocks -%}
    {%- case block.type -%}
      {%- when 'buy' -%}
        window.promotion = {
          show: "{{ block.settings.show_promotion }}",
          reason: "{{ block.settings.promotion_reason }}",
          date: "{{ block.settings.promotion_date }}",
          discount: "{{ block.settings.promotion_discount }}",
          discountUnit: "{{ block.settings.promotion_discount_unit }}"
        };
    {%- endcase -%}
  {%- endfor -%}
  
  window.paintingOptions = {};
  window.paintingOptions.size = [];
  window.paintingOptions.border = [];
  window.paintingOptions.fixation = [];
  window.paintingOptions.frameCanvas = [];

  {% for option in product.metafields.painting_options.sizes.value %}
    {% render 'painting-data-script-window-filler', type: 'size', option: option %}
  {% endfor %}

  {% for option in product.metafields.painting_options.borders.value %}
    {% render 'painting-data-script-window-filler', type: 'border', option: option %}
  {% endfor %}

  {% for option in product.metafields.painting_options.fixations.value %}
    {% render 'painting-data-script-window-filler', type: 'fixation', option: option %}
  {% endfor %}

  {% for option in product.metafields.painting_options.frames_canvas.value %}
    {% render 'painting-data-script-window-filler', type: 'frameCanvas', option: option %}
  {% endfor %}

  function getOptionPrice(option, variantLinked) {
  switch (option.type) {
    case 'size':
      return getSizeOptionPrice(option);
    case 'border':
      return getBorderOptionPrice(option);
    default:
      return getOthersOptionPrice(variantLinked);
  }
}

function getSizeOptionPrice(option) {
  const sizeOption = window.variants.find(variant => variant.option1 === option.name);
  return sizeOption ? Number(sizeOption.price) / 100 : null;
}

function getBorderOptionPrice(option) {
  // Border is now option2, find price difference between borders for same size
  const firstVariant = window.variants[0];
  const size1 = firstVariant.option1;
  const price1 = firstVariant.price;

  const variant2 = window.variants.find(variant =>
    variant.option1 === size1 && variant.option2 === option.name
  );

  if (!variant2) return 0;

  const price2 = variant2.price;
  const priceDifference = Math.abs(price2 - price1) / 100;

  return priceDifference;
}

function getOthersOptionPrice(variantLinked) {
  if (!variantLinked) {
    return 0;
  }
  return variantLinked.price / 100;
}

function getAvailability(option, availability) {
  if (availability) return availability;

  // For border options, check which sizes have this border available
  const variantsContainingOption = window.variants.filter(
    variant => variant.option2 === option.name
  );

  if(!variantsContainingOption.length) return null;

  // Return array of size keys that have this border available
  const sizes = variantsContainingOption.map(variant => {
    const sizeOption = window.paintingOptions.size.find(opt => opt.name === variant.option1);
    return sizeOption.key;
  });

  return [...new Set(sizes)];
}
</script>