{% liquid
  assign item_list_element_names = ''
  assign item_list_element_urls = ''
%}
{% unless template == 'index' or template == 'cart' or template == 'list-collections' %}
  <breadcrumb-popup>
    <nav role="navigation" aria-label="breadcrumbs">
      <div class="my-4 px-4 breadcrumb-wrapper flex items-center gap-2 whitespace-nowrap w-full">
        {%- liquid
          assign home_url = "/"
          assign home_text = 'sections.footer.home' | t
          assign item_list_element_names = home_text
          assign item_list_element_urls = home_url

          # Count total links to determine if we should show popup or all links
          assign total_link_count = 1
          assign show_all_links = false

          # Calculate link count based on template type
          if template contains 'product'
            # Find default painting collection for products
            assign default_painting_collection_temp = null
            for coll in product.collections
              if coll.metafields.custom.type_of_collection == 'painting' and coll.metafields.collection_par_default.boolean == true
                assign default_painting_collection_temp = coll
                break
              endif
            endfor

            if default_painting_collection_temp
              assign total_link_count = total_link_count | plus: 1
            endif
            if product.metafields.link.mother_collection != blank
              assign mother_coll_temp = product.metafields.link.mother_collection.value
              if mother_coll_temp.metafields.breadcrumb.parentCollection.value.url
                assign parent_coll_temp = mother_coll_temp.metafields.breadcrumb.parentCollection.value
                if parent_coll_temp.url != default_painting_collection_temp.url
                  assign total_link_count = total_link_count | plus: 1
                endif
              endif
              if mother_coll_temp.url != default_painting_collection_temp.url
                assign total_link_count = total_link_count | plus: 1
              endif
            elsif collection.url and collection.url != default_painting_collection_temp.url
              assign total_link_count = total_link_count | plus: 1
            endif
          elsif template contains 'collection'
            # Find default painting collection for collections
            assign default_painting_collection_temp = null
            assign all_collections = collections | where: 'handle'
            for coll in all_collections
              if coll.metafields.custom.type_of_collection == 'painting' and coll.metafields.collection_par_default.boolean == true
                assign default_painting_collection_temp = coll
                break
              endif
            endfor

            if collection.metafields.custom.type_of_collection == 'painting' and default_painting_collection_temp and collection.url != default_painting_collection_temp.url
              assign total_link_count = total_link_count | plus: 1
            endif

            assign parent_temp = collection.metafields.breadcrumb.parentCollection | default: collection.metafields.breadcrumb.parentPage
            assign grand_parent_temp = parent_temp.value.metafields.breadcrumb.parentCollection | default: collection.metafields.breadcrumb.parentCollection.value.metafields.breadcrumb.parentPage

            if grand_parent_temp != blank and grand_parent_temp.value.url != default_painting_collection_temp.url
              assign total_link_count = total_link_count | plus: 1
            endif
            if parent_temp != blank and parent_temp.value.url != default_painting_collection_temp.url
              assign total_link_count = total_link_count | plus: 1
            endif
          endif

          # Set show_all_links if 2 or fewer links
          if total_link_count <= 2
            assign show_all_links = true
          endif
        -%}

        <a href="{{ home_url }}" class="text-sm text-main hover:text-[#0b179e] hover:underline hover:underline-offset-2 transition-colors duration-150 no-underline flex-shrink-0 {% if show_all_links %}inline{% else %}hidden md:inline{% endif %}" data-breadcrumb-home data-text="{{ home_text }}">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" class="inline-block"><g fill="none" fill-rule="evenodd"><path d="m12.594 23.258l-.012.002l-.071.035l-.02.004l-.014-.004l-.071-.036q-.016-.004-.024.006l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.016-.018m.264-.113l-.014.002l-.184.093l-.01.01l-.003.011l.018.43l.005.012l.008.008l.201.092q.019.005.029-.008l.004-.014l-.034-.614q-.005-.019-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.003-.011l.018-.43l-.003-.012l-.01-.01z"/><path fill="currentColor" d="M10.671 2.843a2 2 0 0 1 2.658 0l3.934 3.497l.25-1.504a1 1 0 1 1 1.973.328L19.03 7.91l2.635 2.343a1 1 0 0 1-1.328 1.494l-.464-.412l-.787 7.864A2 2 0 0 1 17.095 21H6.905a2 2 0 0 1-1.99-1.801l-.786-7.864l-.465.412a1 1 0 0 1-1.328-1.494zM5.957 9.71q.028.092.038.191l.91 9.1h10.19l.91-9.1q.01-.1.038-.19L12 4.337z"/></g></svg>
        </a>

        {%- comment -%} Ellipsis buttons only (popups rendered outside section) {%- endcomment -%}
        {% if template contains 'product' %}
          {% unless show_all_links %}
            <button type="button" class="breadcrumb-ellipsis inline md:hidden text-sm text-main-70 hover:text-main cursor-pointer" aria-label="Show breadcrumb navigation" data-template="product">...</button>
          {% endunless %}
        {% elsif template contains 'collection' %}
          {% unless show_all_links %}
            <button type="button" class="breadcrumb-ellipsis inline md:hidden text-sm text-main-70 hover:text-main cursor-pointer" aria-label="Show breadcrumb navigation" data-template="collection">...</button>
          {% endunless %}
        {% endif %}

        <div class="breadcrumb-middle-items flex items-center gap-2 overflow-hidden min-w-0">
          {% if template contains 'page' %}
            {%- liquid
              assign item_list_element_names = item_list_element_names | append: '|,|' | append: page.title
              assign item_list_element_urls = item_list_element_urls | append: '|,|' | append: page.url
            -%}
          {% elsif template contains 'product' %}
            {%- comment -%} Find default painting collection {%- endcomment -%}
            {%- liquid
              assign default_painting_collection = null
              for coll in product.collections
                if coll.metafields.custom.type_of_collection == 'painting' and coll.metafields.collection_par_default.boolean == true
                  assign default_painting_collection = coll
                  break
                endif
              endfor

              # Count links for product page
              assign total_link_count = 1
              if default_painting_collection
                assign total_link_count = total_link_count | plus: 1
              endif
              if product.metafields.link.mother_collection != blank
                assign mother_collection = product.metafields.link.mother_collection.value
                if mother_collection.metafields.breadcrumb.parentCollection.value.url
                  assign parent_collection = mother_collection.metafields.breadcrumb.parentCollection.value
                  if parent_collection.url != default_painting_collection.url
                    assign total_link_count = total_link_count | plus: 1
                  endif
                endif
                if mother_collection.url != default_painting_collection.url
                  assign total_link_count = total_link_count | plus: 1
                endif
              elsif collection.url and collection.url != default_painting_collection.url
                assign total_link_count = total_link_count | plus: 1
              endif

              assign show_all_links = false
              if total_link_count <= 2
                assign show_all_links = true
              endif
            -%}

            {%- comment -%} Show default painting collection {%- endcomment -%}
            {% if default_painting_collection %}
              {%- liquid
                assign has_parent = false
                if collection.url or product.metafields.link.mother_collection != blank
                  assign has_parent = true
                endif
              -%}
              <span class="text-main-50 text-lg select-none pointer-events-none {% if has_parent and show_all_links == false %}hidden md:inline{% elsif has_parent == false or show_all_links %}inline{% endif %}">/</span>
              {%- liquid
                assign item_list_element_names = item_list_element_names | append: '|,|' | append: default_painting_collection.title
                assign item_list_element_urls = item_list_element_urls | append: '|,|' | append: default_painting_collection.url
              -%}
              <a href="{{ default_painting_collection.url }}" class="text-sm text-main hover:text-[#0b179e] hover:underline hover:underline-offset-2 transition-colors duration-150 no-underline {% if has_parent and show_all_links == false %}hidden md:inline{% elsif has_parent == false or show_all_links %}inline{% endif %}">{{ default_painting_collection.title }}</a>
            {% endif %}

            {%- comment -%} Show hierarchy {%- endcomment -%}
            {% if collection.url and collection.url != default_painting_collection.url %}
              <span class="text-main-50 text-lg select-none pointer-events-none {% if show_all_links %}inline{% else %}hidden md:inline{% endif %}">/</span>
              {%- liquid
                assign item_list_element_names = item_list_element_names | append: '|,|' | append: collection.title
                assign item_list_element_urls = item_list_element_urls | append: '|,|' | append: collection.url
              -%}
              <a href="{{ collection.url }}" class="text-sm text-main hover:text-[#0b179e] hover:underline hover:underline-offset-2 transition-colors duration-150 no-underline {% if show_all_links %}inline{% else %}hidden md:inline{% endif %}">{{ collection.title }}</a>
            {% elsif product.metafields.link.mother_collection != blank %}
              {%- liquid
                assign mother_collection = product.metafields.link.mother_collection.value
              -%}

              {%- comment -%} Show grandparent (parent of mother) - always visible on mobile {%- endcomment -%}
              {% if mother_collection.metafields.breadcrumb.parentCollection.value.url %}
                {%- liquid
                  assign parent_collection = mother_collection.metafields.breadcrumb.parentCollection.value
                -%}
                {% if parent_collection.url != default_painting_collection.url %}
                  <span class="text-main-50 text-lg select-none pointer-events-none flex-shrink-0">/</span>
                  {%- liquid
                    assign item_list_element_names = item_list_element_names | append: '|,|' | append: parent_collection.title
                    assign item_list_element_urls = item_list_element_urls | append: '|,|' | append: parent_collection.url
                  -%}
                  <div class="min-w-0">
                    <a href="{{ parent_collection.url }}" class="text-sm text-main hover:text-[#0b179e] hover:underline hover:underline-offset-2 transition-colors duration-150 no-underline truncate block">{{ parent_collection.title }}</a>
                  </div>
                {% endif %}
              {% endif %}

              {%- comment -%} Show parent (mother collection) - always visible on mobile {%- endcomment -%}
              {% if mother_collection.url != default_painting_collection.url %}
                <span class="text-main-50 text-lg select-none pointer-events-none flex-shrink-0">/</span>
                {%- liquid
                  assign item_list_element_names = item_list_element_names | append: '|,|' | append: mother_collection.title
                  assign item_list_element_urls = item_list_element_urls | append: '|,|' | append: mother_collection.url
                -%}
                <div class="min-w-0">
                  <a href="{{ mother_collection.url }}" class="text-sm text-main hover:text-[#0b179e] hover:underline hover:underline-offset-2 transition-colors duration-150 no-underline truncate block">{{ mother_collection.title }}</a>
                </div>
              {% endif %}
            {% endif %}

            {%- liquid
              assign item_list_element_names = item_list_element_names | append: '|,|' | append: product.title
              assign item_list_element_urls = item_list_element_urls | append: '|,|' | append: product.url
            -%}
          {% elsif template contains 'collection' and collection.handle %}
            {%- comment -%} Find default painting collection {%- endcomment -%}
            {%- liquid
              assign default_painting_collection = null
              assign all_collections = collections | where: 'handle'
              for coll in all_collections
                if coll.metafields.custom.type_of_collection == 'painting' and coll.metafields.collection_par_default.boolean == true
                  assign default_painting_collection = coll
                  break
                endif
              endfor

              # Count links for collection page
              assign total_link_count = 1
              if collection.metafields.custom.type_of_collection == 'painting' and default_painting_collection and collection.url != default_painting_collection.url
                assign total_link_count = total_link_count | plus: 1
              endif

              assign parent = collection.metafields.breadcrumb.parentCollection | default: collection.metafields.breadcrumb.parentPage
              assign grand_parent = parent.value.metafields.breadcrumb.parentCollection | default: collection.metafields.breadcrumb.parentCollection.value.metafields.breadcrumb.parentPage

              if grand_parent != blank and grand_parent.value.url != default_painting_collection.url
                assign total_link_count = total_link_count | plus: 1
              endif
              if parent != blank and parent.value.url != default_painting_collection.url
                assign total_link_count = total_link_count | plus: 1
              endif

              assign show_all_links = false
              if total_link_count <= 2
                assign show_all_links = true
              endif
            -%}

            {%- comment -%} Show default painting collection {%- endcomment -%}
            {% if collection.metafields.custom.type_of_collection == 'painting' and default_painting_collection and collection.url != default_painting_collection.url %}
              <span class="text-main-50 text-lg select-none pointer-events-none {% if show_all_links %}inline{% else %}hidden md:inline{% endif %}">/</span>
              {%- liquid
                assign item_list_element_names = item_list_element_names | append: '|,|' | append: default_painting_collection.title
                assign item_list_element_urls = item_list_element_urls | append: '|,|' | append: default_painting_collection.url
              -%}
              <a href="{{ default_painting_collection.url }}" class="text-sm text-main hover:text-[#0b179e] hover:underline hover:underline-offset-2 transition-colors duration-150 no-underline {% if show_all_links %}inline{% else %}hidden md:inline{% endif %}">{{ default_painting_collection.title }}</a>
            {% endif %}

            {%- comment -%} Show grandparent {%- endcomment -%}
            {% if grand_parent != blank and grand_parent.value.url != default_painting_collection.url %}
              <span class="text-main-50 text-lg select-none pointer-events-none {% if show_all_links %}inline{% else %}hidden md:inline{% endif %}">/</span>
              {%- liquid
                assign item_list_element_urls = item_list_element_urls | append: '|,|' | append: grand_parent.value.url
                assign item_list_element_names = item_list_element_names | append: '|,|' | append: grand_parent.value.title
              -%}
              <a href="{{ grand_parent.value.url }}" class="text-sm text-main hover:text-[#0b179e] hover:underline hover:underline-offset-2 transition-colors duration-150 no-underline {% if show_all_links %}inline{% else %}hidden md:inline{% endif %}">{{ grand_parent.value.title }}</a>
            {% endif %}

            {%- comment -%} Show parent (always visible on mobile) {%- endcomment -%}
            {% if parent != blank and parent.value.url != default_painting_collection.url %}
              <span class="text-main-50 text-lg select-none pointer-events-none flex-shrink-0">/</span>
              {%- liquid
                assign item_list_element_names = item_list_element_names | append: '|,|' | append: parent.value.title
                assign item_list_element_urls = item_list_element_urls | append: '|,|' | append: parent.value.url
              -%}
              <div class="flex-1 min-w-0">
                <a href="{{ parent.value.url }}" class="text-sm text-main hover:text-[#0b179e] hover:underline hover:underline-offset-2 transition-colors duration-150 no-underline truncate block">{{ parent.value.title }}</a>
              </div>
            {% endif %}

            {%- liquid
              assign item_list_element_names = item_list_element_names | append: '|,|' | append: collection.title
              assign item_list_element_urls = item_list_element_urls | append: '|,|' | append: collection.url
            -%}
          {% endif %}
        </div>

        {% unless template contains 'product' %}
          <span class="text-main-50 text-lg select-none pointer-events-none">/</span>
          <span class="text-sm text-main font-semibold">
            {%- liquid
              if template contains 'page'
                echo page.title
              elsif template contains 'collection'
                echo collection.title
              endif
            -%}
          </span>
        {% endunless %}
      </div>
    </nav>
  </breadcrumb-popup>
{% endunless %}

{%- comment -%} Popup containers outside overflow context {%- endcomment -%}
<div class="breadcrumb-popup-container fixed invisible opacity-0 bg-secondary border border-main-20 rounded-md shadow-lg py-2 z-50 transition-all duration-200 min-w-[200px]">
  <ul class="breadcrumb-popup-list flex flex-col gap-1"></ul>
</div>

{%- assign item_list_element_names = item_list_element_names | split: '|,|' -%}
{%- assign item_list_element_urls = item_list_element_urls | split: '|,|' -%}

<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
    {%- for itemListElement_name in item_list_element_names -%}
      {
        "@type": "ListItem",
        "position": {{ forloop.index }},
        "name": "{{ itemListElement_name }}",
        "item": "{{ shop.secure_url }}{{ item_list_element_urls[forloop.index0] }}"
    }{%- if forloop.last == false -%},{%- endif -%}
    {%- endfor -%}
    ]
  }
</script>

<script src="{{ 'breadcrumb-popup.js' | asset_url }}" defer></script>

{% schema %}
{
  "name": "t:sections.breadcrumb.name",
  "class": "page-width w-full overflow-hidden",
  "tag": "div",
  "limit": 1,
  "enabled_on": {
    "templates": [
      "collection",
      "page",
      "product"
    ]
  },
  "presets": [
    {
      "name": "t:sections.breadcrumb.name"
    }
  ]
}
{% endschema %}
